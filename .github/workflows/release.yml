name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0, v1.2.3, etc.

permissions:
  contents: write
  actions: read

jobs:
  build-and-release:
    name: Build and Create GitHub Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Create debug keystore for signing
        run: |
          mkdir -p ~/.android
          if [ ! -f ~/.android/debug.keystore ]; then
            keytool -genkeypair -v \
              -keystore ~/.android/debug.keystore \
              -storepass android \
              -alias androiddebugkey \
              -keypass android \
              -keyalg RSA \
              -keysize 2048 \
              -validity 10000 \
              -dname "CN=Android Debug,O=Android,C=US"
          fi

      - name: Build release APK
        run: ./gradlew assembleRelease

      - name: Validate APK is properly signed
        run: |
          APK_PATH=$(find app/build/outputs/apk/release -name "*.apk" -type f | head -1)
          echo "Found APK: $APK_PATH"
          
          APKSIGNER=$(find "$ANDROID_SDK_ROOT/build-tools" -name "apksigner" 2>/dev/null | sort -V 2>/dev/null | tail -1)
          if [ -z "$APKSIGNER" ]; then
            APKSIGNER=$(find "$ANDROID_SDK_ROOT/build-tools" -name "apksigner" 2>/dev/null | head -1)
          fi
          
          if [ -n "$APKSIGNER" ]; then
            echo "Verifying APK signature with apksigner..."
            if "$APKSIGNER" verify --verbose "$APK_PATH"; then
              echo "âœ… APK is properly signed and ready for distribution"
            else
              echo "âŒ APK signature verification failed"
              exit 1
            fi
          else
            echo "âš ï¸ apksigner not found, checking for signature files in APK..."
            if unzip -l "$APK_PATH" | grep -q "META-INF/.*\.\(RSA\|DSA\|EC\|SF\)"; then
              echo "âœ… APK contains signature files"
            else
              echo "âŒ APK appears to be unsigned"
              exit 1
            fi
          fi

      - name: Extract version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Rename APK with version
        id: rename-apk
        run: |
          APK_PATH=$(find app/build/outputs/apk/release -name "*.apk" -type f | head -1)
          APK_DIR=$(dirname "$APK_PATH")
          NEW_APK_NAME="officesuite-v${{ steps.get_version.outputs.version }}.apk"
          mv "$APK_PATH" "$APK_DIR/$NEW_APK_NAME"
          echo "apk_path=$APK_DIR/$NEW_APK_NAME" >> $GITHUB_OUTPUT
          echo "apk_name=$NEW_APK_NAME" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release v${{ steps.get_version.outputs.version }}
          body: |
            ## ðŸ“± Office Suite v${{ steps.get_version.outputs.version }}
            
            ### ðŸ“¥ Download & Install
            
            1. Download the APK file below
            2. Enable "Install from unknown sources" in your device settings (if not already enabled)
            3. Open the downloaded APK file to install
            4. The app will update automatically if you have a previous version installed
            
            ### âœ… APK Information
            
            - **File**: ${{ steps.rename-apk.outputs.apk_name }}
            - **Signed**: Yes (ready to install on any Android device)
            - **Min Android Version**: Android 8.0 (API 26)
            - **Package**: com.officesuite.app
            
            ### ðŸŽ‰ What's New
            
            Please see the commit history for details on changes in this release.
            
            ---
            *Built from commit ${{ github.sha }}*
          files: ${{ steps.rename-apk.outputs.apk_path }}
          draft: false
          prerelease: false

      - name: Summary
        run: |
          echo "## ðŸš€ Release Published Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: v${{ steps.get_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**APK**: ${{ steps.rename-apk.outputs.apk_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download from: [Releases page](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.get_version.outputs.version }})" >> $GITHUB_STEP_SUMMARY
